---
import type { ContentZoneBlock, PostEntity, RichTextBlock } from "../../types";
import { apiGet } from "../../lib/services";
import BlogPost from "../../layouts/BlogPost.astro";
import GallerySlider from "../../components/GallerySlider.astro";
import PictureBlock from "../../components/PictureBlock.astro";
import MarkdownBlock from "../../components/MarkdownBlock.astro";
import { resolveLang, toDateLang } from "../../lib/locale";

const { slug } = Astro.params;
if (!slug) throw new Error("Slug parameter is required");
const lang = resolveLang(Astro.url, Astro.request.headers.get("accept-language"));
const dateLang = toDateLang(lang);

const fetchPostByLang = (queryLang: "es" | "de") =>
  apiGet<PostEntity[]>("/api/posts", {
    "filters[slug][$eq]": slug,
    "pagination[pageSize]": "1",
    locale: queryLang,
    "populate[coverImage][populate]": "*",
    "populate[contenZone][on][sections.rich-text][populate]": "*",
    "populate[contenZone][on][sections.slider][populate][images][populate]": "*",
    "populate[contenZone][on][sections.picture][populate][image][populate]": "*",
    "populate[contenZone][on][sections.markdown][populate]": "*",
  });

let response = await fetchPostByLang(lang);
let post = response.data[0];
if (!post && lang !== "es") {
  response = await fetchPostByLang("es");
  post = response.data[0];
}

if (!post) throw new Error(`Post not found for slug: ${slug}`);

const zoneBlocks = (post.contenZone ?? []) as ContentZoneBlock[];
const hasZoneBlocks = zoneBlocks.length > 0;

const richTextHtml =
  !hasZoneBlocks && post.content
    ? Array.isArray(post.content)
      ? richTextToHtml(post.content)
      : post.content
    : null;

function escapeHtml(value: string) {
  return value
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/\"/g, "&quot;")
    .replace(/'/g, "&#39;");
}

function inlineMarksToHtml(node: RichTextBlock) {
  const raw = node.text ?? "";
  let html = escapeHtml(raw);

  if (node.code) html = `<code>${html}</code>`;
  if (node.bold) html = `<strong>${html}</strong>`;
  if (node.italic) html = `<em>${html}</em>`;
  if (node.underline) html = `<u>${html}</u>`;
  if (node.strikethrough) html = `<s>${html}</s>`;
  if (node.type === "link" && node.url) {
    const safeUrl = escapeHtml(node.url);
    html = `<a href="${safeUrl}" rel="noopener noreferrer">${html}</a>`;
  }

  return html;
}

function richTextToHtml(blocks: RichTextBlock[]) {
  return blocks
    .map((block) => {
      const children = block.children ?? [];
      const text = children.map(inlineMarksToHtml).join("");

      switch (block.type) {
        case "heading": {
          const level = Math.min(Math.max(block.level ?? 2, 1), 6);
          return `<h${level}>${text}</h${level}>`;
        }
        case "list": {
          const tag = block.format === "ordered" ? "ol" : "ul";
          const items = children
            .map((child) => {
              const liText = (child.children ?? [])
                .map(inlineMarksToHtml)
                .join("");
              return `<li>${liText}</li>`;
            })
            .join("");
          return `<${tag}>${items}</${tag}>`;
        }
        case "quote":
          return `<blockquote>${text}</blockquote>`;
        case "code":
          return `<pre><code>${escapeHtml(
            block.text ?? children.map((c) => c.text ?? "").join(""),
          )}</code></pre>`;
        case "paragraph":
        default:
          return text.trim() ? `<p>${text}</p>` : "";
      }
    })
    .filter(Boolean)
    .join("");
}
---

<BlogPost {...post} lang={dateLang}>
  {
    hasZoneBlocks ? (
      zoneBlocks.map((block) => {
        switch (block.__component) {
          case "sections.rich-text":
            return <div set:html={richTextToHtml(block.body ?? [])} />;
          case "sections.slider":
            return (
              <GallerySlider
                images={block.images}
                title={post.title}
                caption={block.caption}
                autoplay={block.autoplay}
              />
            );
          case "sections.picture":
            return (
              <PictureBlock
                image={block.image}
                alt={block.alt}
                fallbackAlt={post.title}
              />
            );
          case "sections.markdown":
            return <MarkdownBlock body={block.body} />;
          default:
            return null;
        }
      })
    ) : post.markdown ? (
      <MarkdownBlock body={post.markdown} />
    ) : richTextHtml ? (
      <div set:html={richTextHtml} />
    ) : post.excerpt ? (
      <p>
        <em>{post.excerpt}</em>
      </p>
    ) : null
  }

  {
    !hasZoneBlocks && post.gallery ? (
      <GallerySlider gallery={post.gallery} title={post.title} />
    ) : null
  }
</BlogPost>
