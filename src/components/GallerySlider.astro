---
import type { ContentMediaCover } from "../types";
import { mediaUrl } from "../consts";

type Props = {
  gallery?: ContentMediaCover[] | null;
  images?: ContentMediaCover[] | null;
  title?: string;
  caption?: string | null;
  autoplay?: boolean | null;
};

const {
  gallery = [],
  images = [],
  title = "",
  caption = null,
  autoplay = null,
} = Astro.props;

const sliderImages = [...(images ?? []), ...(gallery ?? [])]
  .map((image) => ({
    url:
      mediaUrl(image.formats?.large?.url) ??
      mediaUrl(image.formats?.medium?.url) ??
      mediaUrl(image.formats?.small?.url) ??
      mediaUrl(image.url),
    alt: image.alternativeText || title,
  }))
  .filter((item) => item.url);
---

{
  sliderImages.length > 0 && (
    <section class="gallery-slider" aria-label="GalerÃ­a">
      <swiper-container
        class="js-gallery-swiper"
        init="false"
        slides-per-view="1"
        space-between="12"
        pagination="true"
        navigation="true"
        zoom="true"
        loop="true"
        centered-slides="true"
        autoplay={autoplay ? "true" : undefined}
      >
        {sliderImages.map((img) => (
          <swiper-slide>
            <div class="swiper-zoom-container">
              <img src={img.url} alt={img.alt} />
            </div>
          </swiper-slide>
        ))}
      </swiper-container>
      {caption ? <p class="caption">{caption}</p> : null}
    </section>
  )
}

<script>
  import { register } from "swiper/element/bundle";

  if (!customElements.get("swiper-container")) {
    register();
  }

  type SwiperContainerElement = Element & {
    swiper?: unknown;
    initialize?: () => void;
  };

  document
    .querySelectorAll("swiper-container.js-gallery-swiper")
    .forEach((el) => {
      const swiperEl = el as SwiperContainerElement;
      if (!swiperEl.swiper) {
        swiperEl.initialize?.();
      }
    });
</script>

<style>
  .gallery-slider {
    --slider-accent: rgb(var(--accent));
    --slider-accent-soft: color-mix(in srgb, var(--slider-accent) 30%, white);
    width: min(980px, calc(100% - 2em));
    margin: 1.5em auto 0;
    padding: 0 1em;
  }

  .gallery-slider :global(swiper-container) {
    --swiper-navigation-color: var(--slider-accent);
    --swiper-pagination-color: var(--slider-accent);
    --swiper-pagination-bullet-inactive-color: var(--slider-accent-soft);
    --swiper-pagination-bullet-inactive-opacity: 1;
    width: 100%;
    padding-bottom: 24px;
  }

  .gallery-slider :global(swiper-slide) {
    display: grid;
  }

  .gallery-slider :global(swiper-slide img) {
    width: 100%;
    height: 100%;
    display: block;
    object-fit: cover;
    border-radius: 12px;
    box-shadow: var(--box-shadow);
  }

  .caption {
    margin: 0.35rem 0 0;
    color: rgb(var(--gray));
    font-size: 0.95rem;
    text-align: center;
  }
</style>
